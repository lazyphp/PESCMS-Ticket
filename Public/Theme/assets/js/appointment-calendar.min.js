!function(T){T.fn.appointmentCalendar=function(t){var S=T.extend({maxBookingTime:14,workMode:0,holidays:[],appointmentType:"full_day",capacity:{},onDateSelect:function(){},onTimeSelect:function(){}},t);if(Array.isArray(S.holidays)||(S.holidays=[]),"object"!=typeof S.capacity&&(S.capacity={}),0===Object.keys(S.capacity).length&&"time_slot"===S.appointmentType)for(var e=9;e<17;e++)S.capacity[e]=10;return this.each(function(){var f=T(this),p=T(S.dateInputSelector||".appointment-date-input"),u=T(S.timeInputSelector||"#appointment_time"),m=T(S.timeSlotsContainerSelector||"#time-slots-container"),v=T(S.timeSlotsSelector||"#time-slots");T(".ajax-submit").on("submit",function(t){var e,a;if(0<p.length)return e=p.val(),a=u.val(),e?"time_slot"!==S.appointmentType||a?void 0:(alert("请选择预约时间段"),t.preventDefault(),!1):(alert("请选择预约日期"),t.preventDefault(),!1)});for(var t=new Date,e=(t.setHours(0,0,0,0),t.getFullYear()),a=t.getMonth(),n=new Date(e,a,1),i=new Date,e=(i.setDate(t.getDate()+S.maxBookingTime),'<div class="calendar-header"><button type="button" class="prev-month am-btn am-btn-default am-btn-xs">&lt;</button><span class="current-month">'+(a+1)+"月 "+e+'</span><button type="button" class="next-month am-btn am-btn-default am-btn-xs">&gt;</button></div>'),o=["日","一","二","三","四","五","六"],s='<div class="week-header">',l=0;l<7;l++)s+='<div class="week-day">'+o[l]+"</div>";s+="</div>";for(var r=n.getDay(),d=new Date(n),c=(d.setDate(d.getDate()-r),'<div class="calendar-days">'),l=0;l<42;l++){var y=new Date(d),h=(y.setDate(d.getDate()+l),y.getMonth()===a),D=y.toDateString()===t.toDateString(),g=x(y,t,i),b="calendar-day",h=(h||(b+=" other-month"),D&&(b+=" today"),g||(b+=" disabled"),k(y)),D=y.getDate();c+='<div class="'+b+'" data-date="'+h+'">'+D+"</div>"}function w(t){for(var e=f.find(".current-month").text().trim().split(" "),a=parseInt(e[0])-1,e=parseInt(e[1]),t=((a+=t)<0?(a=11,e--):11<a&&(a=0,e++),f.find(".current-month").text(a+1+"月 "+e),new Date(e,a,1)),e=t.getDay(),n=new Date(t),i=(n.setDate(n.getDate()-e),new Date),o=(i.setHours(0,0,0,0),new Date),s=(o.setDate(i.getDate()+S.maxBookingTime),f.find(".calendar-day")),l=0;l<s.length;l++){var r=new Date(n),d=(r.setDate(n.getDate()+l),r.getMonth()===a),c=r.toDateString()===i.toDateString(),p=x(r,i,o),u=T(s[l]);u.removeClass("other-month today disabled selected"),d||u.addClass("other-month"),c&&u.addClass("today"),p||u.addClass("disabled"),u.data("date",k(r)),u.text(r.getDate())}}function x(t,e,a){if(t.valueOf()<e.valueOf())return!1;if(t.valueOf()>a.valueOf())return!1;e=Math.floor(t.valueOf()/1e3);if(Array.isArray(S.holidays)&&-1!==S.holidays.indexOf(e))return!1;try{var n=t.getDay();if(0===S.workMode&&(0===n||6===n))return!1;if(1===S.workMode&&0!==n&&6!==n)return!1}catch(t){console.error("Date filtering error:",t)}return!0}function k(t){return t.getFullYear()+"-"+C(t.getMonth()+1)+"-"+C(t.getDate())}function C(t){return(t<10?"0":"")+t}n='<div class="custom-calendar">'+e+s+(c+="</div>")+"</div>",f.html(n),f.find(".prev-month").on("click",function(){w(-1)}),f.find(".next-month").on("click",function(){w(1)}),f.find(".calendar-day").on("click",function(){if(!T(this).hasClass("disabled")){f.find(".calendar-day").removeClass("selected"),T(this).addClass("selected");var t=T(this).data("date");if(p.val(t),u.val(""),"time_slot"===S.appointmentType){(d=new Date(t))instanceof Date&&!isNaN(d.getTime())||(d=new Date);var e=v,a=(e.empty(),k(d));m.removeClass("am-hide");var n,i,o,s,l,r,d=["日","一","二","三","四","五","六"][d.getDay()],a=T('<div class="date-title"></div>').text(a+"（周"+d+"）预约时间段");if(e.append(a),0===Object.keys(S.capacity).length)for(var c=9;c<17;c++)S.capacity[c]=10;for(n in S.capacity)S.capacity.hasOwnProperty(n)&&(i=parseInt(n),o=parseInt(S.capacity[n]),s=T('<div class="slot" data-time="'+i+'"></div>'),o<=0&&s.addClass("full"),l=T('<div class="slot-time"></div>').text(C(i)+":00 - "+C(i+1)+":00"),r=T('<div class="slot-people"></div>').text(o<=0?"已满":"剩余 "+o+" 个"),s.append(l),s.append(r),e.append(s),0<o)&&!function(t){s.on("click",function(){T(".slot").removeClass("selected"),T(this).addClass("selected"),u.val(t),S.onTimeSelect.call(this,t)})}(i)}else u.val("full_day"),m.addClass("am-hide");S.onDateSelect.call(this,t)}})})}}(jQuery);