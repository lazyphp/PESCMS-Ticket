$(function(){let i,s=2,e=null;function o(){var t=document.getElementsByClassName("pes-chat")[0];t.scrollTop=t.scrollHeight}function l(t){let a={clean:!1,append:!1,page:1,success:function(){}};i&&i.abort();var e=$('input[name="number"]').val();let n=$(".pes-chat");Object.assign(a,t),i=$.getJSON("/?g=Ticket&m=Ticket&a=handle&number="+e+"&getChat=1&page="+a.page,function(t){var e;200==t.status&&((e=$("<div>").html(t.data.html)).find("img").each(function(){var t,e=$(this);"a"!=e.parent()[0].tagName.toLowerCase()&&(t='<a href="'+e.attr("src")+'" data-fancybox="gallery" class="am-inline-block view-pic">'+e.prop("outerHTML")+"</a>",e.prop("outerHTML",t))}),e=e.html(),1==a.append?s<=parseInt(t.data.totalPages)&&n.prepend(e):(n.html(e),n.attr("data",t.data.pageTotal)),1==a.clean)&&ue.setContent("",!1),a.success(t)})}setTimeout(function(){o(),0==$(".ticket-reply").length&&$(".ticket-service").removeClass("ticket-service")},200);$("#submit-reply").on("submit",function(){var t=$(this).attr("action");let n=$("input[name=assign]:checked").val();return $.ajaxsubmit({url:t,data:$(this).serializeArray(),dialog:!1},function(t,e){if(200==t.status){if(3==n||4==n)return window.location.reload(),!1;l({clean:!0}),s=2,setTimeout(function(){o()},200)}else{e.content='<i class="am-icon-times-circle"></i> '+t.msg;var a=dialog(e).showModal();setTimeout(function(){a.close().remove()},3e3)}}),!1}),$(".pes-chat").scroll(function(){0<$(this).scrollTop()&&$(this).scrollTop()<400&&(null==e||s<=e)&&l({append:!0,page:s,success:function(t){200==t.status&&(s++,e=t.data.totalPages)}})}),setInterval(function(){var t=$('input[name="number"]').val();$.get("/?g=Ticket&m=Ticket&a=handle&number="+t+"&replyRefresh=checked",function(t){parseInt($(".pes-chat").attr("data"))<parseInt(t)&&l()})},5e3),$(".show-pt-info").on("click",function(){$(this).toggleClass("active"),$(this).hasClass("active")?($(this).find("i").removeClass("am-icon-angle-double-down").addClass("am-icon-angle-double-up"),$(this).find(".text").text("收起详情"),$(".pt-info-panel").slideDown(100)):($(this).find("i").removeClass("am-icon-angle-double-up").addClass("am-icon-angle-double-down"),$(this).find(".text").text("展开详情"),$(".pt-info-panel").slideUp(100))}),$(document).on("click",function(t){0<$(".ticket-reply").length&&($(t.target).closest(".show-pt-info, .pt-info-panel").length||($(".show-pt-info").find("i").removeClass("am-icon-angle-double-up").addClass("am-icon-angle-double-down"),$(".show-pt-info").find(".text").text("展开详情"),$(".pt-info-panel").slideUp(100)))})});