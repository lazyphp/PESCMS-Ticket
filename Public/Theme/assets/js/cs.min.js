$(function(){let i,s=2,t=null;$(".cs-title").removeClass("am-hide");function o(){var e=document.getElementsByClassName("pes-chat")[0];e.scrollTop=e.scrollHeight}function l(e){let a={clean:!1,append:!1,page:1,success:function(){}};i&&i.abort();var t=$('input[name="number"]').val();let n=$(".pes-chat");Object.assign(a,e),i=$.getJSON("/?g=Ticket&m=Ticket&a=handle&number="+t+"&getChat=1&page="+a.page,function(e){var t;200==e.status&&((t=$("<div>").html(e.data.html)).find("img").each(function(){var e,t=$(this);"a"!=t.parent()[0].tagName.toLowerCase()&&(e='<a href="'+t.attr("src")+'" data-fancybox="gallery" class="am-inline-block view-pic">'+t.prop("outerHTML")+"</a>",t.prop("outerHTML",e))}),t=t.html(),1==a.append?s<=parseInt(e.data.totalPages)&&n.prepend(t):(n.html(t),n.attr("data",e.data.pageTotal)),1==a.clean)&&ue.setContent("",!1),a.success(e)})}setTimeout(function(){o(),0==$(".ticket-reply").length&&$(".ticket-service").removeClass("ticket-service")},200);$("#submit-reply").on("submit",function(){var e=$(this).attr("action");let n=$("input[name=assign]:checked").val();return $.ajaxsubmit({url:e,data:$(this).serializeArray(),dialog:!1},function(e,t){if(200==e.status){if(3==n||4==n)return window.location.reload(),!1;l({clean:!0}),s=2,setTimeout(function(){o()},200)}else{t.content='<i class="am-icon-times-circle"></i> '+e.msg;var a=dialog(t).showModal();setTimeout(function(){a.close().remove()},3e3)}}),!1}),$(".pes-chat").scroll(function(){0<$(this).scrollTop()&&$(this).scrollTop()<400&&(null==t||s<=t)&&l({append:!0,page:s,success:function(e){200==e.status&&(s++,t=e.data.totalPages)}})}),setInterval(function(){var e=$('input[name="number"]').val();$.get("/?g=Ticket&m=Ticket&a=handle&number="+e+"&replyRefresh=checked",function(e){parseInt($(".pes-chat").attr("data"))<parseInt(e)&&l()})},5e3),$(".show-pt-info").on("click",function(){$(this).toggleClass("active"),$(this).hasClass("active")?($(this).find("i").removeClass("am-icon-angle-double-down").addClass("am-icon-angle-double-up"),$(this).find(".text").text("收起详情"),$(".pt-info-panel").slideDown(100)):($(this).find("i").removeClass("am-icon-angle-double-up").addClass("am-icon-angle-double-down"),$(this).find(".text").text("展开详情"),$(".pt-info-panel").slideUp(100))}),$(document).on("click",function(e){0<$(".ticket-reply").length&&($(e.target).closest(".show-pt-info, .pt-info-panel").length||($(".show-pt-info").find("i").removeClass("am-icon-angle-double-up").addClass("am-icon-angle-double-down"),$(".show-pt-info").find(".text").text("展开详情"),$(".pt-info-panel").slideUp(100)))})});